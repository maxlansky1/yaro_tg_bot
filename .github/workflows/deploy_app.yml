name: –ê–≤—Ç–æ–¥–µ–ø–ª–æ–π

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    environment: vps_deploy
    steps:

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        run: |
          echo "üîç DEBUG OUTPUT:"
          echo "SSH_HOST:       ${{ secrets.SSH_HOST }}"
          echo "SSH_USER:       ${{ secrets.SSH_USER }}"
          echo "SSH_PORT:       ${{ secrets.SSH_PORT }}"
          echo "SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}"
          echo "DEPLOY_PATH:    ${{ secrets.DEPLOY_PATH }}"
          echo "TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}"
          echo "REPO_NAME:      ${{ github.repository }}"
          echo "COMMIT_SHA:     ${{ github.sha }}"

          # –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –ø—É—Å—Ç—ã–µ –ª–∏ –∫–ª—é—á–µ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
          if [[ -z "${{ secrets.SSH_HOST }}" ]]; then echo "‚ùå SSH_HOST is empty"; fi
          if [[ -z "${{ secrets.SSH_USER }}" ]]; then echo "‚ùå SSH_USER is empty"; fi
          if [[ -z "${{ secrets.SSH_PORT }}" ]]; then echo "‚ùå SSH_PORT is empty"; fi
          if [[ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]]; then echo "‚ùå SSH_PRIVATE_KEY is empty"; fi
          if [[ -z "${{ secrets.DEPLOY_PATH }}" ]]; then echo "‚ùå DEPLOY_PATH is empty"; fi

      - name: –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–µ—Å–±–æ—Ä–∫—É/—Ä–µ—Å—Ç–∞—Ä—Ç
        id: changes
        run: |
          # –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –ø–µ—Ä–≤—ã–π –ª–∏ —ç—Ç–æ –∫–æ–º–º–∏—Ç
          if [[ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]]; then
            # –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –º–µ–∂–¥—É –∫–æ–º–º–∏—Ç–∞–º–∏
            changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }})
            echo "$changed_files"
          else
            echo "–ü–µ—Ä–≤—ã–π –∫–æ–º–º–∏—Ç ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞"
            echo "run_rebuild=true" >> $GITHUB_ENV
            exit 0
          fi

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Dockerfile, docker-compose –∏–ª–∏ requirements.txt
          if echo "$changed_files" | grep -qE '(Dockerfile|docker-compose.*\.yml|requirements\.txt)'; then
            echo "run_rebuild=true" >> $GITHUB_ENV
            echo "action_type=–ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞" >> $GITHUB_ENV
          else
            echo "run_rebuild=false" >> $GITHUB_ENV
            echo "action_type=–†–µ—Å—Ç–∞—Ä—Ç" >> $GITHUB_ENV
          fi

      - name: –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        run: |
          echo "REPO_NAME=$(basename ${{ github.repository }})" >> $GITHUB_ENV

      - name: –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø–æ SSH
        id: ssh-connect
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ 
            cd "${{ secrets.DEPLOY_PATH }}/${{ env.REPO_NAME }}"
            
            # –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –ª—é–±—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            git reset --hard

            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ git –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–ª–∏—è–Ω–∏—è
            git config pull.rebase false

            # –ü–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ main
            git pull

            # –í—ã–ø–æ–ª–Ω—è–µ–º –Ω—É–∂–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
            if [ "${{ env.run_rebuild }}" = "true" ]; then
              echo "üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–Ω—ã–π rebuild..."
              make rebuild
            else
              echo "üîÅ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏..."
              make restart
            fi

            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            docker ps -a

      - name: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–∞
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          REPO_NAME: ${{ github.repository }}
          COMMIT_SHA: ${{ github.sha }}
          CONTAINERS: ${{ steps.ssh-connect.outputs.stdout }}
          ACTION_TYPE: ${{ env.action_type }}

        run: |
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          MESSAGE="‚úÖ <b>${action_type}</b>

          üì¶ <b>Repo:</b> <code>${REPO_NAME}</code>
          üìå <b>Commit:</b> <a href='https://github.com/${REPO_NAME}/commit/${COMMIT_SHA}'>${COMMIT_SHA:0:7}</a>
          üïí <b>Time:</b> $(date '+%Y-%m-%d %H:%M:%S')

          üìã <b>–ó–∞–ø—É—â–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:</b>
          <pre>${CONTAINERS}</pre>

          üîó <a href='https://github.com/${REPO_NAME}/actions/runs/${GITHUB_RUN_ID}'>View in GitHub Actions</a>"

          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="HTML" \
            --data-urlencode text="$MESSAGE"