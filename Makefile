# ================================
# üõ†Ô∏è Makefile
# ================================

# –°—á–∏—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏—Ö
include .env

# –£–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–æ–π —Ñ–∞–π–ª docker-compose –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
COMPOSE_FILE=docker-compose.yaml
DC = docker-compose

# –°–µ—Ä–≤–∏—Å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, app)
SERVICE ?= app

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞—á
.PHONY: help up down restart build rebuild logs bash prune docs-clean docs-html

# =============================================
# üìå –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´
# =============================================

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
ps:
	docker ps -a
# 
# ‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ —Ñ–æ–Ω–µ
# –ò—Å–ø–æ–ª—å–∑—É–π –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏ –∏–ª–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–æ–µ–∫—Ç–∞
up:
	$(DC) up -d

# ‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
# –ù–µ —É–¥–∞–ª—è–µ—Ç –æ–±—Ä–∞–∑—ã –∏ –¥–∞–Ω–Ω—ã–µ
down:
	$(DC) down

# üîÅ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏
# –ü–æ–ª–µ–∑–Ω–æ, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è –∫–æ–¥, –Ω–æ –Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
restart:
	$(MAKE) down
	$(MAKE) up

# üî® –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã —Å –Ω—É–ª—è + –æ—á–∏—Å—Ç–∫–∞ –º—É—Å–æ—Ä–∞
# –¢–æ–ª—å–∫–æ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ requirements.txt –∏–ª–∏ Dockerfile
build:
	$(DC) build --no-cache

# üîÅüîÑ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ ‚Üí —É–¥–∞–ª–µ–Ω–∏–µ ‚Üí –∑–∞–ø—É—Å–∫
# –ò—Å–ø–æ–ª—å–∑—É–π, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –≤—Å—ë –æ–±–Ω–æ–≤–∏—Ç—å "–æ—Ç –∏ –¥–æ"
rebuild: prune build up

# üîç –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
logs:
	docker logs -f $(DOCKER_CONTAINER_NAME)

# üñ•Ô∏è –í—Ö–æ–¥ –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —á–µ—Ä–µ–∑ bash (–∏–ª–∏ sh)
bash:
	$(DC) exec $(SERVICE) /bin/bash || \
	$(DC) exec $(SERVICE) /bin/sh

# üóëÔ∏è –û—á–∏—Å—Ç–∫–∞: —É–¥–∞–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤ —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
prune:
	$(DC) down --rmi local --volumes --remove-orphans

# –û—á–∏—Å—Ç–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
docs-clean:
	cd docs && make clean

# –°–±–æ—Ä–∫–∞ HTML-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
docs-html:
	cd docs && make html

# =============================================
# üí° –ü–ê–ú–Ø–¢–ö–ê: –ö–∞–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
# =============================================

# üü¢ –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –∏–ª–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏:
# make up

# üü° –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ (–Ω–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö):
# make restart

# üîµ –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ requirements.txt –∏–ª–∏ Dockerfile:
# make build

# üî¥ –ß—Ç–æ–±—ã –≤—Å—ë –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å "—Å –Ω—É–ª—è" –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å:
# make rebuild

# üü£ –ß—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏:
# make logs

# üü† –ß—Ç–æ–±—ã –∑–∞–ª–µ–∑—Ç—å –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
# make bash

# ‚ö´ –ß—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ:
# make prune

# üü§ –î–ª—è —Å–ø—Ä–∞–≤–∫–∏:
help:
	@echo "üìå –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo ""
	@echo "  make up            ‚ûú –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
	@echo "  make down          ‚ûú –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
	@echo "  make restart       ‚ûú –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å (–±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏)"
	@echo "  make build         ‚ûú –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã —Å –Ω—É–ª—è"
	@echo "  make rebuild       ‚ûú –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª: down ‚Üí build ‚Üí up"
	@echo "  make logs          ‚ûú –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏"
	@echo "  make bash          ‚ûú –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä"
	@echo "  make prune         ‚ûú –ü–æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ"
	@echo "  make help          ‚ûú –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞"
